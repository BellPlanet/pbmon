<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>pbmon</title>
</head>
<body>
  use the Console, Luke!
  <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
  <script src="https://unpkg.com/protobufjs@6.8.6/dist/protobuf.js"></script>
  <script>
    (function() {
      const logStream = (level, o) => {
        const now = new Date
        console.log(o, ['[', level, ' ', now.toString(), '] '].join(''));
      };

      const loadProto = protobuf.load('/proto');
      const loadProtoSettings = $.get('/proto/settings');

      Promise.all([loadProto, loadProtoSettings])
        .then((p) => {
          const [root, settings] = p;
          logStream('info', 'proto loaded');

          const Message = root.lookupType(settings.message_type);
          if (!Message) {
            logStream('error', [settings.message_type, ' not found'].join(''));
            return;
          }

          const wshost = ['ws://', location.host, '/stream'].join('');
          const ws = new WebSocket(wshost);
          ws.binaryType = 'arraybuffer';

          ws.onopen = () => {
            logStream('info', 'connected');
          };

          ws.onmessage = (raw) => {
            const buf = new Uint8Array(raw.data);
            const message = Message.decode(protobuf.Reader.create(buf));
            console.log(message);
          };
        });
    })();
  </script>
</body>
</html>
